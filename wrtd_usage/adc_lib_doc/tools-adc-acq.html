

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>The adc-acq Tools &mdash; ADC Library 2.2.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'2.2.0',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: ''
          };
      </script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="The Example Tools" href="tools-example.html" />
    <link rel="prev" title="The Library API" href="library-api.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> ADC Library
          

          
          </a>

          
            
            
              <div class="version">
                2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="library-user.html">The Library For Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="library-devel.html">The Library For Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="library-api.html">The Library API</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">The <code class="docutils literal"><span class="pre">adc-acq</span></code> Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools-example.html">The Example Tools</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ADC Library</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>The <code class="docutils literal"><span class="pre">adc-acq</span></code> Tools</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/tools-adc-acq.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-adc-acq-tools">
<h1>The <code class="docutils literal"><span class="pre">adc-acq</span></code> Tools<a class="headerlink" href="#the-adc-acq-tools" title="Permalink to this headline">Â¶</a></h1>
<p>The <code class="docutils literal"><span class="pre">adc-acq</span></code> is supposed to be a generic tool to be used to driver
acquisitions. The tool tries to export all the library&#8217;s features to
its users.</p>
<p>Generally speaking, this is not a tool that you should use operationally.
This tools is supposed to be used as a tesing tool.</p>
<p>Instead of having a dedicated command line argument for each of the
possible ADC configuration options, we decided to use configuration
strings. This has the advantage to simplify the code and the simplify
the usage of the tool, especially when the user wants to configure
many things.</p>
<p>For most of the option the help message from the <code class="docutils literal"><span class="pre">adc-acq</span></code> tools is
self-explanatory. Probably the configuration strings need some clarifications.</p>
<dl class="docutils">
<dt>Acquisition (<code class="docutils literal"><span class="pre">--acquisition</span> <span class="pre">&lt;pre-sample&gt;,&lt;post-sample&gt;,&lt;n-shots&gt;,&lt;undersample&gt;</span></code>)</dt>
<dd><p class="first">The <em>&lt;pre-sample&gt;</em> is the number of sample to acquire before the trigger.</p>
<p>The <em>&lt;post-sample&gt;</em> is the number of samples to acquire after the trigger
(including the sample that triggered the acquisition).</p>
<p>The <em>&lt;n-shots&gt;</em> is the number of consecutive acquisition to perform with
the same configuration.</p>
<p class="last">The <em>&lt;undersample&gt;</em> is a factor used to reducing the sampling rate buy
skipping samples (e.g. undersample=3 will get 1 sample every 3).</p>
</dd>
<dt>Channel (<code class="docutils literal"><span class="pre">--channel</span> <span class="pre">&lt;channel&gt;,&lt;termination&gt;,&lt;range&gt;,&lt;offset&gt;,&lt;saturation&gt;</span></code>)</dt>
<dd><p class="first">The <em>&lt;channel&gt;</em> is the channel index in the range [0, N].</p>
<p>The <em>&lt;termination&gt;</em> is 0 to disable or 1 to enable the termination on the
channel.</p>
<p>The <em>&lt;range&gt;</em> is the operation voltage range of the ADC. This value
depends on the device in use</p>
<p>The <em>&lt;offset&gt;</em> is used to move the signal.</p>
<p class="last">The <em>&lt;saturation&gt;</em> is the value at which the channel must saturate.</p>
</dd>
<dt>External Trigger (<code class="docutils literal"><span class="pre">--trg-ext</span> <span class="pre">&lt;idx&gt;,&lt;enable&gt;,&lt;polarity&gt;,&lt;delay&gt;</span></code>)</dt>
<dd><p class="first">The <em>&lt;idx&gt;</em> is the Nth external trigger channel in the range [0, N].</p>
<p>The <em>&lt;polarity&gt;</em> is 0 for positive edge/slope or 1 for negative edge/slope.</p>
<p class="last">The <em>&lt;delay&gt;</em> is number of samples to wait before actually starting the
acquisition (without account for undersampling).</p>
</dd>
<dt>Threshold Trigger (<code class="docutils literal"><span class="pre">--trg-thr</span> <span class="pre">&lt;idx&gt;,&lt;enable&gt;,&lt;polarity&gt;,&lt;threshold&gt;,&lt;hysteresis&gt;,&lt;delay&gt;</span></code>)</dt>
<dd><p class="first">The index <em>&lt;idx&gt;</em> is the Nth threshold trigger channel in the range [0, N].</p>
<p>The polarity <em>&lt;polarity&gt;</em> is 0 for positive edge/slope or 1 for
negative edge/slope.</p>
<p>The threshold <em>&lt;threshold&gt;</em> is the raw value that makes trigger the ADC on
a given channel.</p>
<p>The hysteresis <em>&lt;hysteresis&gt;</em> is the error tollerance for the threshold.</p>
<p class="last">The delay <em>&lt;delay&gt;</em> is number of samples to wait before actually starting
the acquisition (without account for undersampling).</p>
</dd>
<dt>Timer Trigger (<code class="docutils literal"><span class="pre">--trg-tim</span></code>)</dt>
<dd>Not implemented yet</dd>
</dl>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cm">/* Copyright 2013 CERN</span>
<span class="cm"> * Author: Federico Vaga &lt;federico.vaga@vaga.pv.it&gt;</span>
<span class="cm"> * License: GPLv2</span>
<span class="cm"> *</span>
<span class="cm"> * This is a simple program to configure the FMC ADC trigger. It is not bug</span>
<span class="cm"> * aware because it is only a demo program</span>
<span class="cm"> */</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;getopt.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;limits.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;inttypes.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;adc-lib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;adc-lib-100m14b4cha.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">arg_show_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arg_no_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arg_plot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arg_x_display</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arg_trgsw_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arg_trgsw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fixup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">statistics</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">git_version</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;version: &quot;</span> <span class="n">GIT_VERSION</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">help_msg</span> <span class="o">=</span>
	<span class="s">&quot;adc-acq -D &lt;device-name&gt;@0x&lt;device-id&gt; [OPTIONS]</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">help_msg_opt</span> <span class="o">=</span>
<span class="s">&quot;  --device|-D &lt;device-name&gt;@&lt;device-id&gt;: unique device identifier  (e.g.: </span><span class="se">\&quot;</span><span class="s">fmc-adc@0x0400</span><span class="se">\&quot;</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --acquisition|-a &lt;parameters&gt;        configure the acquisition</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;        &lt;pre-sample&gt;,&lt;post-sample&gt;,&lt;n-shots&gt;,&lt;undersample&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --trg-ext &lt;parameters&gt;               configure an external trigger</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;        &lt;idx&gt;,&lt;enable&gt;,&lt;polarity&gt;,&lt;delay&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --trg-thr &lt;parameters&gt;               configure a threshold trigger</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;        &lt;idx&gt;,&lt;enable&gt;,&lt;polarity&gt;,&lt;threshold&gt;,&lt;hysteresis&gt;,&lt;delay&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --trg-tim &lt;parameters&gt;               configure a timing trigger</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;        &lt;idx&gt;,&lt;enable&gt;,&lt;seconds&gt;,&lt;nanoseconds&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --trg-sw &lt;parameters&gt;                configure a software trigger</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;        &lt;delay_seconds&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --off-clr &lt;ac-mode&gt;,&lt;idx&gt;               run offset-clear on a given channel</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --channel| -c &lt;parameters&gt;           configure an acquisition channel</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;        &lt;channel&gt;,&lt;termination&gt;,&lt;range&gt;,&lt;offset&gt;,&lt;saturation&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --timeout|-T &lt;millisec&gt;  timeout for acquisition</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --binary|-B &lt;file&gt;       save binary to &lt;file&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --multi-binary|-M &lt;file&gt; save two files per shot: &quot;</span>
					<span class="s">&quot;&lt;file&gt;.0000.ctrl etc</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --dont-read|-N           config-only</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --loop|-l &lt;num&gt;          number of loop before exiting</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --show-data|-s &lt;num&gt;     how many data to display: &quot;</span>
					<span class="s">&quot;&gt;0 from head, &lt;0 from tail</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --plot                   plot acquisition</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --X11|-X                 Gnuplot will use X connection</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --stats                  It prints some statistics</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --version|-V             print version information</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  --help|-h                show this help</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">help_msg_opt_desc</span> <span class="o">=</span>
<span class="s">&quot;Parameter descriptions (alphabetic order)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;ac-mode&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    Offset auto-clear mode mode, a: automatic (use library configuration), m: manual (use user configuration)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;enable&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    enabled: 1, disabled: 0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;idx&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    resource index [0, N]</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;nanoseconds&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    number of nanoseconds since the card base time.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;n-shots&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    number of consecutive acquisitions</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;offset&gt;*</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    offset to apply on input channel</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;polarity&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    positive edge/slope: 0, negative edge/slope: 1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;post-sample&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    number of samples to be acquired after trigger (including the trigger)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;pre-sample&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    number of samples to be acquired before trigger</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;range&gt;*</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    voltage range to use</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;saturation&gt;*</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    saturation value for an input channel</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;seconds&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    number of seconds since the card base time.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;termination&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    enabled: 1, disabled: 0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;threshold&gt;*</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    &lt;adc-value&gt; that trigger the acquisition</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  &lt;undersample&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    number of samples to skip during the acquisition</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    * The meaning depends on the board in used</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fald_help</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">fputs</span><span class="p">(</span><span class="n">help_msg</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot; &lt;device-name&gt;: name of the device type to open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">__ADC_SUPPORTED_BOARDS_LAST_INDEX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adc_board_name</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">fputs</span><span class="p">(</span><span class="n">help_msg_opt</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
	<span class="n">fputs</span><span class="p">(</span><span class="n">help_msg_opt_desc</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">enum</span> <span class="n">fald_acq_options</span> <span class="p">{</span>
	<span class="n">FALD_ACQ_OPT_TRG_EXT</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="n">FALD_ACQ_OPT_TRG_THR</span><span class="p">,</span>
	<span class="n">FALD_ACQ_OPT_TRG_TIM</span><span class="p">,</span>
	<span class="n">FALD_ACQ_OPT_TRG_SW</span><span class="p">,</span>
	<span class="n">FALD_ACQ_OPT_OFF_CLR</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="nc">option</span> <span class="n">options</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;device&quot;</span><span class="p">,</span>	<span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;acquisition&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;trg-ext&quot;</span><span class="p">,</span>	<span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FALD_ACQ_OPT_TRG_EXT</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;trg-thr&quot;</span><span class="p">,</span>	<span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FALD_ACQ_OPT_TRG_THR</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;trg-tim&quot;</span><span class="p">,</span>	<span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FALD_ACQ_OPT_TRG_TIM</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;trg-sw&quot;</span><span class="p">,</span>	<span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FALD_ACQ_OPT_TRG_SW</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;channel&quot;</span><span class="p">,</span>	<span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;c&#39;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;timeout&quot;</span><span class="p">,</span>	<span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;off-clr&quot;</span><span class="p">,</span>	<span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FALD_ACQ_OPT_OFF_CLR</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;fixup&quot;</span><span class="p">,</span>	<span class="n">no_argument</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fixup</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;stats&quot;</span><span class="p">,</span>	<span class="n">no_argument</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">statistics</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>


	<span class="cm">/* new options, to help stress-test */</span>
	<span class="p">{</span><span class="s">&quot;binary&quot;</span><span class="p">,</span>	<span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;multi-binary&quot;</span><span class="p">,</span><span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;M&#39;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;dont-read&quot;</span><span class="p">,</span>	<span class="n">no_argument</span><span class="p">,</span>       <span class="o">&amp;</span><span class="n">arg_no_read</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;loop&quot;</span><span class="p">,</span>	<span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;l&#39;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;show-data&quot;</span><span class="p">,</span>	<span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;s&#39;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;plot&quot;</span><span class="p">,</span>	<span class="n">no_argument</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg_plot</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;X11&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg_x_display</span> <span class="p">,</span> <span class="mi">1</span><span class="p">},</span>

	<span class="cm">/* loop for stess test */</span>
	<span class="p">{</span><span class="s">&quot;loop&quot;</span><span class="p">,</span>	<span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;l&#39;</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;version&quot;</span><span class="p">,</span>	<span class="n">no_argument</span><span class="p">,</span>       <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;help&quot;</span><span class="p">,</span> 	<span class="n">no_argument</span><span class="p">,</span>       <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;h&#39;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;show-config&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span>       <span class="o">&amp;</span><span class="n">arg_show_config</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define GETOPT_STRING &quot;D:Vha:c:T:B:M:l:s:&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_version</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">pname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pname</span><span class="p">,</span> <span class="n">git_version</span><span class="p">);</span>
	<span class="n">adc_print_version</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* variables shared between threads */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">devname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">show_ndata</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span> <span class="cm">/* by default all values are displayed */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">binmode</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">-1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">basefile</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_argv</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

<span class="cm">/* default is 1 V*/</span>
<span class="k">static</span> <span class="kt">double</span> <span class="n">bit_scale</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span>



<span class="cm">/**</span>
<span class="cm"> * It shows the current configuration</span>
<span class="cm"> * @param[in] adc the ADC token</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fald_acq_print_config</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_dev</span> <span class="o">*</span><span class="n">adc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="nc">adc_conf</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">cfg_brd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">value</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg_show_config</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Show the configuration only the first time,</span>
<span class="cm">	 * not at every loop iteration</span>
<span class="cm">	 */</span>
	<span class="n">arg_show_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;Board Configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_conf</span><span class="p">));</span>
	<span class="n">cfg_brd</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ADC_CONF_TYPE_BRD</span><span class="p">;</span>
	<span class="n">adc_set_conf_mask_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">adc</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_retrieve_config</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Cannot retrieve the board configuration: (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">errno</span><span class="p">,</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Status: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_STATE_MACHINE_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">State machine: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_MAX_FREQ_HZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Max sampling frequency: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_MIN_FREQ_HZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Min sampling frequency: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_N_CHAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Number of channels: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_N_TRG_EXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Number of external triggers: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_N_TRG_THR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Number of threshold triggers: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_N_TRG_TIM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Number of timer triggers: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_UTC_TIMING_BASE_S</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Time Seconds: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_UTC_TIMING_BASE_T</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Time sub-second ticks: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_UTC_TIMING_BASE_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Time sub-second bins: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;Acquisition Configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_conf</span><span class="p">));</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ADC_CONF_TYPE_ACQ</span><span class="p">;</span>
	<span class="n">adc_set_conf_mask_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">adc</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_retrieve_config</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Cannot retrieve the acquisition configuration: (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">errno</span><span class="p">,</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_N_SHOTS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Shots: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_PRE_SAMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Pre samples: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_POST_SAMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Post samples: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_UNDERSAMPLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Undersample (decimation): %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_FREQ_HZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Sampling rate: %u Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_N_BITS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Bit per sample: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;Channel Configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_conf</span><span class="p">));</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ADC_CONF_TYPE_CHN</span><span class="p">;</span>
	<span class="n">adc_set_conf_mask_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">adc</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_N_CHAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">route_to</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_retrieve_config</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;Cannot retrieve the external trigger configuration (): (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">errno</span><span class="p">,</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_CHN_RANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Range: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_CHN_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Offset: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_CHN_SATURATION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Saturation: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_CHN_TERMINATION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Termination: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;Trigger (External) Configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_conf</span><span class="p">));</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ADC_CONF_TYPE_TRG_EXT</span><span class="p">;</span>
	<span class="n">adc_set_conf_mask_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">adc</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_N_TRG_EXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">External trigger %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">route_to</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_retrieve_config</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;Cannot retrieve the external trigger configuration (): (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">errno</span><span class="p">,</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_EXT_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Enable: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_EXT_POLARITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Polarity: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_EXT_DELAY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Delay: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;Trigger (Threshold) Configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_conf</span><span class="p">));</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ADC_CONF_TYPE_TRG_THR</span><span class="p">;</span>
	<span class="n">adc_set_conf_mask_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">adc</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_N_TRG_THR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Threshold trigger %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">route_to</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_retrieve_config</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;Cannot retrieve the external trigger configuration (): (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">errno</span><span class="p">,</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_THR_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Enable: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_THR_POLARITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Polarity: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_THR_DELAY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Delay: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_THR_THRESHOLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Threshold: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_THR_HYSTERESIS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Hysteresis: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;Trigger (Time) Configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_conf</span><span class="p">));</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ADC_CONF_TYPE_TRG_TIM</span><span class="p">;</span>
	<span class="n">adc_set_conf_mask_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">adc</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_N_TRG_THR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Timer trigger %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">route_to</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_retrieve_config</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;Cannot retrieve the timer trigger configuration: (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">errno</span><span class="p">,</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_TIM_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Enable: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_TIM_SECONDS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Seconds: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_get_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_TIM_NANO_SECONDS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Nanoseconds: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * It writes data on file</span>
<span class="cm"> * @param[in] filename file where write data</span>
<span class="cm"> * @param[in] ch the channel data to write</span>
<span class="cm"> * @param[in] pdata data from ADC (is interleaved)</span>
<span class="cm"> * @param[in] n_sample number of sample in pdata (is interleaved)</span>
<span class="cm"> * @return 0 on success, otherwise -1 and errno is appropriately set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int16_t</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_sample</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">filp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* set umask to have a file with 0666 mode */</span>
	<span class="n">filp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
	<span class="n">umask</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span> <span class="cm">/* restore previous umask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;fopen %s failed: %s&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pdata</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_sample</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="n">pdata</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">double</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="p">)</span><span class="o">*</span><span class="n">bit_scale</span><span class="p">;</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="s">&quot;%d %g</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fclose</span><span class="p">(</span><span class="n">filp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * It configures the acquisition according to the parameters&#39; string</span>
<span class="cm"> * @param[in] adc The ADC device token</span>
<span class="cm"> * @param[in] param a parameter string in the form</span>
<span class="cm"> *     &quot;&lt;pre-sample&gt;,&lt;post-sample&gt;,&lt;n-shots&gt;,&lt;undersample&gt;&quot;</span>
<span class="cm"> * @return 0 on success, otherwise -1 and errno is appropriately set</span>
<span class="cm"> *</span>
<span class="cm"> * The parameters are not mandatory. If not provided, the application will</span>
<span class="cm"> * not try to set them (there is not a default value)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fald_acq_acquisition_configuration</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_dev</span> <span class="o">*</span><span class="n">adc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="nc">adc_conf</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">nshot</span><span class="p">,</span> <span class="n">under</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s">&quot;%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">pre</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">post</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">under</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_conf</span><span class="p">));</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ADC_CONF_TYPE_ACQ</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_UNDERSAMPLE</span><span class="p">,</span> <span class="n">under</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_N_SHOTS</span><span class="p">,</span> <span class="n">nshot</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_POST_SAMP</span><span class="p">,</span> <span class="n">post</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_PRE_SAMP</span><span class="p">,</span> <span class="n">pre</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">default</span><span class="o">:</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">adc_apply_config</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * It configures a channel according to the parameters&#39; string</span>
<span class="cm"> * @param[in] adc The ADC device token</span>
<span class="cm"> * @param[in] param a parameter string in the form</span>
<span class="cm"> *     &quot;&lt;channel&gt;,&lt;termination&gt;,&lt;range&gt;,&lt;offset&gt;,&lt;saturation&gt;&quot;</span>
<span class="cm"> * @return 0 on success, otherwise -1 and errno is appropriately set</span>
<span class="cm"> *</span>
<span class="cm"> * The parameters are not mandatory. If not provided, the application will</span>
<span class="cm"> * not try to set them (there is not a default value)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fald_acq_channel_configuration</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_dev</span> <span class="o">*</span><span class="n">adc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="nc">adc_conf</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ch</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">sat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s">&quot;%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">term</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* channel is mandatory */</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_conf</span><span class="p">));</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ADC_CONF_TYPE_CHN</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">route_to</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_CHN_SATURATION</span><span class="p">,</span> <span class="n">sat</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_CHN_OFFSET</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
		<span class="cm">/*</span>
<span class="cm">		 * in-range</span>
<span class="cm">		 * 0x23 (35): 100mV range</span>
<span class="cm">		 * 0x11 (17): 1V range</span>
<span class="cm">		 * 0x45 (69): 10V range</span>
<span class="cm">		 * 0x00 (0): Open input</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">range</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">100</span><span class="o">:</span>
			<span class="n">range</span> <span class="o">=</span> <span class="n">ADC_CONF_100M14B4CHA_CHN_RANGE_100mV</span><span class="p">;</span>
			<span class="n">bit_scale</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
			<span class="n">range</span> <span class="o">=</span> <span class="n">ADC_CONF_100M14B4CHA_CHN_RANGE_1V</span><span class="p">;</span>
			<span class="n">bit_scale</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">10</span><span class="o">:</span>
			<span class="n">range</span> <span class="o">=</span> <span class="n">ADC_CONF_100M14B4CHA_CHN_RANGE_10V</span><span class="p">;</span>
			<span class="n">bit_scale</span> <span class="o">=</span> <span class="mf">5.0</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_CHN_RANGE</span><span class="p">,</span> <span class="n">range</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_CHN_TERMINATION</span><span class="p">,</span> <span class="n">term</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">default</span><span class="o">:</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">adc_apply_config</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * It configures a software trigger according to the parameters&#39; string</span>
<span class="cm"> * @param[in] adc The ADC device token</span>
<span class="cm"> * @param[in] param a parameter string in the form</span>
<span class="cm"> *     &quot;&lt;delay&gt;&quot;</span>
<span class="cm"> * @return 0 on success, otherwise -1 and errno is appropriately set</span>
<span class="cm"> *</span>
<span class="cm"> * The parameters are not mandatory. If not provided, the application will</span>
<span class="cm"> * not try to set them (there is not a default value)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fald_trg_software_configuration</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_dev</span> <span class="o">*</span><span class="n">adc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s">&quot;%&quot;</span><span class="n">SCNu32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* channel is mandatory */</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adc_has_trigger_fire</span><span class="p">(</span><span class="n">adc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Software trigger not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">ADC_ENOP</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">arg_trgsw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
		<span class="n">arg_trgsw_delay</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">default</span><span class="o">:</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * It configures a external trigger according to the parameters&#39; string</span>
<span class="cm"> * @param[in] adc The ADC device token</span>
<span class="cm"> * @param[in] param a parameter string in the form</span>
<span class="cm"> *     &quot;&lt;idx&gt;,&lt;enable&gt;,&lt;polarity&gt;,&lt;delay&gt;&quot;</span>
<span class="cm"> * @return 0 on success, otherwise -1 and errno is appropriately set</span>
<span class="cm"> *</span>
<span class="cm"> * The parameters are not mandatory. If not provided, the application will</span>
<span class="cm"> * not try to set them (there is not a default value)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fald_trg_external_configuration</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_dev</span> <span class="o">*</span><span class="n">adc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="nc">adc_conf</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">n</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">polarity</span><span class="p">,</span> <span class="n">delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s">&quot;%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">polarity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* channel is mandatory */</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_conf</span><span class="p">));</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ADC_CONF_TYPE_TRG_EXT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">route_to</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_EXT_DELAY</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_EXT_POLARITY</span><span class="p">,</span> <span class="n">polarity</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_EXT_ENABLE</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">default</span><span class="o">:</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">adc_apply_config</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * It configures a threshold trigger according to the parameters&#39; string</span>
<span class="cm"> * @param[in] adc The ADC device token</span>
<span class="cm"> * @param[in] param a parameter string in the form</span>
<span class="cm"> *     &quot;&lt;idx&gt;,&lt;enable&gt;,&lt;polarity&gt;,&lt;threshold&gt;,&lt;hysteresis&gt;,&lt;delay&gt;&quot;</span>
<span class="cm"> * @return 0 on success, otherwise -1 and errno is appropriately set</span>
<span class="cm"> *</span>
<span class="cm"> * The parameters are not mandatory. If not provided, the application will</span>
<span class="cm"> * not try to set them (there is not a default value)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fald_trg_threshold_configuration</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_dev</span> <span class="o">*</span><span class="n">adc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="nc">adc_conf</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">n</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">polarity</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">hysteresis</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s">&quot;%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">polarity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">threshold</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hysteresis</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* channel is mandatory */</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_conf</span><span class="p">));</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ADC_CONF_TYPE_TRG_THR</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">route_to</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_THR_DELAY</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_THR_HYSTERESIS</span><span class="p">,</span> <span class="n">hysteresis</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_THR_THRESHOLD</span><span class="p">,</span> <span class="n">threshold</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_THR_POLARITY</span><span class="p">,</span> <span class="n">polarity</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_THR_ENABLE</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">default</span><span class="o">:</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">adc_apply_config</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * It configures a timer trigger according to the parameters&#39; string</span>
<span class="cm"> * @param[in] adc The ADC device token</span>
<span class="cm"> * @param[in] param a parameter string in the form</span>
<span class="cm"> *     &quot;&lt;channel&gt;,&lt;termination&gt;,&lt;range&gt;,&lt;offset&gt;,&lt;saturation&gt;&quot;</span>
<span class="cm"> * @return 0 on success, otherwise -1 and errno is appropriately set</span>
<span class="cm"> *</span>
<span class="cm"> * The parameters are not mandatory. If not provided, the application will</span>
<span class="cm"> * not try to set them (there is not a default value)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fald_trg_timer_configuration</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_dev</span> <span class="o">*</span><span class="n">adc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="nc">adc_conf</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">n</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">nanoseconds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s">&quot;%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="s">&quot;,%&quot;</span><span class="n">SCNu32</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seconds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nanoseconds</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_conf</span><span class="p">));</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ADC_CONF_TYPE_TRG_TIM</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">route_to</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
	<span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_TIM_NANO_SECONDS</span><span class="p">,</span> <span class="n">nanoseconds</span><span class="p">);</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_TIM_SECONDS</span><span class="p">,</span> <span class="n">seconds</span><span class="p">);</span>
		<span class="n">adc_set_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ADC_CONF_TRG_TIM_ENABLE</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">default</span><span class="o">:</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">adc_apply_config</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * It peforms the auto-clear offset according to the command line options</span>
<span class="cm"> * @param[in] adc The ADC device token</span>
<span class="cm"> * @param[in] argc number of arguments</span>
<span class="cm"> * @param[in] argv arguments</span>
<span class="cm"> * @return 0 on success, otherwise -1 and errno is appropriately set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adc_acq_offset_auto_clear</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_dev</span> <span class="o">*</span><span class="n">adc</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">offclr_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span>  <span class="n">opt_index</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">optind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* set to 1 to make getopt_long happy */</span>
	<span class="cm">/* Parse options */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">getopt_long</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">GETOPT_STRING</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt_index</span><span class="p">))</span>
	       <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nl">FALD_ACQ_OPT_OFF_CLR</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offclr_mode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">offclr_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;m&#39;</span><span class="o">:</span>
				<span class="n">flags</span> <span class="o">|=</span> <span class="n">ADC_OFFSET_AC_F_MANUAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;a&#39;</span><span class="o">:</span>
				<span class="n">flags</span> <span class="o">|=</span> <span class="n">ADC_OFFSET_AC_F_RESTORE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;z&#39;</span><span class="o">:</span>
				<span class="n">flags</span> <span class="o">|=</span> <span class="n">ADC_OFFSET_AC_F_ZERO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">default</span><span class="o">:</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
					<span class="s">&quot;%s: invalid offset auto-clear mode &#39;%c&#39; (valid modes: {a: automatic, m: manual})&quot;</span><span class="p">,</span>
					<span class="n">_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">offclr_mode</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">adc_offset_auto_clear</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">default</span><span class="o">:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * It parses command line arguments and consequential it configures the device</span>
<span class="cm"> * @param[in] argc number of arguments</span>
<span class="cm"> * @param[in] argv arguments</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fald_acq_parse_args_and_configure</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_dev</span> <span class="o">*</span><span class="n">adc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">opt_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">optind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* set to 1 to make getopt_long happy */</span>
	<span class="cm">/* Parse options */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">getopt_long</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">GETOPT_STRING</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt_index</span><span class="p">))</span>
	       <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;a&#39;</span><span class="o">:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fald_acq_acquisition_configuration</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: Cannot configure acquisition: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
				<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span><span class="o">:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fald_acq_channel_configuration</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: Cannot configure channel: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
				<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="nl">FALD_ACQ_OPT_TRG_EXT</span><span class="p">:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fald_trg_external_configuration</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: Cannot configure external trigger: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
				<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="nl">FALD_ACQ_OPT_TRG_THR</span><span class="p">:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fald_trg_threshold_configuration</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: Cannot configure threshold trigger: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
				<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="nl">FALD_ACQ_OPT_TRG_TIM</span><span class="p">:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fald_trg_timer_configuration</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: Cannot configure timer trigger: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
				<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="nl">FALD_ACQ_OPT_TRG_SW</span><span class="p">:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fald_trg_software_configuration</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: Cannot configure software trigger: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
				<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;T&#39;</span><span class="o">:</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;B&#39;</span><span class="o">:</span>
			<span class="n">binmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* do binary (default is 0) */</span>
			<span class="n">basefile</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;M&#39;</span><span class="o">:</span>
			<span class="n">binmode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* do many binaries */</span>
			<span class="n">basefile</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;l&#39;</span><span class="o">:</span>
			<span class="n">loop</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span><span class="o">:</span>
			<span class="n">show_ndata</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">default</span><span class="o">:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_acq_offset_auto_clear</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>

	<span class="n">fald_acq_print_config</span><span class="p">(</span><span class="n">adc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * It prints data to stdout</span>
<span class="cm"> * @param[in] ctrl</span>
<span class="cm"> * @param[in] buf buffer to print</span>
<span class="cm"> * @param[in] acq_cfg acquisition configuration associated to the buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fald_acq_print_data</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="k">struct</span> <span class="nc">adc_conf</span> <span class="o">*</span><span class="n">acq_brd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="nc">adc_conf</span> <span class="o">*</span><span class="n">acq_cfg</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pre</span><span class="p">,</span> <span class="n">nchan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">adc_get_conf</span><span class="p">(</span><span class="n">acq_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_N_CHAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nchan</span><span class="p">);</span>
	<span class="n">adc_get_conf</span><span class="p">(</span><span class="n">acq_cfg</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_PRE_SAMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pre</span><span class="p">);</span>

	<span class="cm">/* Print data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">nsamples</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%5i     &quot;</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">pre</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">nchan</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int32_t</span> <span class="n">sample</span><span class="p">;</span>

				<span class="n">adc_buffer_get_sample</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample</span><span class="p">);</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%7i&quot;</span><span class="p">,</span> <span class="n">sample</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Save data to a single file</span>
<span class="cm"> * @param[in] buf buffer to store</span>
<span class="cm"> * @return 0 on success, otherwise -1 and errno is appropriately set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fald_acq_write_single</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">fname</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
	<span class="kt">int16_t</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>  <span class="cm">/* FMC-ADC-100M sample size is 14bit, 16bit for ZIO */</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">basefile</span><span class="p">);</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef FIXME</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">metadata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fwrite</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">zio_control</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">)</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;write(%s): short write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">basefile</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Sava data to different file for control and data for each shot</span>
<span class="cm"> * @param[in] buf buffer to store</span>
<span class="cm"> * @param[in] shot_i i-th shot acquisition</span>
<span class="cm"> * @return 0 on success, otherwise -1 and errno is appropriately set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fald_acq_write_multiple</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shot_i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">fname</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

<span class="cp">#ifdef FIXME</span>
	<span class="cm">/* FIXME zio control is specific. The library should provide</span>
<span class="cm">	   at least the metadata size so that automatic tools can at least</span>
<span class="cm">	   read */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&quot;%s.%03u.ctrl&quot;</span><span class="p">,</span> <span class="n">basefile</span><span class="p">,</span> <span class="n">shot_i</span><span class="p">);</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">metadata</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">zio_control</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
	<span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;write(%s): short write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#endif</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&quot;%s.%03u.data&quot;</span><span class="p">,</span> <span class="n">basefile</span><span class="p">,</span> <span class="n">shot_i</span><span class="p">);</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;write(%s): short write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Plot data using gnuplot</span>
<span class="cm"> * @param[in] buf buffer to plot</span>
<span class="cm"> * @param[in] ch channel to show</span>
<span class="cm"> * @return 0 on success, otherwise -1 and errno is appropriately set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fald_acq_plot_data</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int16_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">fname</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">PATH_MAX</span> <span class="o">+</span> <span class="mi">256</span><span class="p">];</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="s">&quot;/tmp/fmcadc.0x%04x.ch%u.dat&quot;</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Cannot plot data. Write data into file %s failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="s">&quot;echo </span><span class="se">\&quot;</span><span class="s">%s plot &#39;%s&#39; with lines &quot;</span>
		 <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> | gnuplot -persist&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">arg_x_display</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;set term x11; &quot;</span> <span class="o">:</span> <span class="s">&quot;set term dumb; &quot;</span><span class="p">),</span>
		 <span class="n">fname</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * It prints data using json format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adc_acq_statistics</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;{</span><span class="se">\&quot;</span><span class="s">statistics</span><span class="se">\&quot;</span><span class="s">: [&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_chan</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="kt">int32_t</span> <span class="n">avg</span><span class="p">;</span>

		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;{ </span><span class="se">\&quot;</span><span class="s">chan</span><span class="se">\&quot;</span><span class="s">: %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_buffer_math_avg</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">avg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">average</span><span class="se">\&quot;</span><span class="s">: -1&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;, </span><span class="se">\&quot;</span><span class="s">average</span><span class="se">\&quot;</span><span class="s">: %&quot;</span><span class="n">PRId32</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">max_chan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;}&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;}, &quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;]}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * It process the buffer</span>
<span class="cm"> * @param[in] buf the buffer to use</span>
<span class="cm"> * @param[in] iteration loop iteration number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fald_acq_process_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="nc">adc_conf</span> <span class="o">*</span><span class="n">cfg_brd</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="nc">adc_conf</span> <span class="o">*</span><span class="n">cfg_acq</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iteration</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="nc">adc_timestamp</span> <span class="n">ts</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">nchan</span><span class="p">;</span>

	<span class="n">adc_tstamp_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>

	<span class="cm">/* print/store data*/</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">binmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">default</span><span class="o">:</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;time: {secs:%&quot;</span><span class="n">PRIu64</span><span class="s">&quot; ticks:%&quot;</span><span class="n">PRIu64</span><span class="s">&quot; bins:%&quot;</span><span class="n">PRIu64</span><span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ts</span><span class="p">.</span><span class="n">secs</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">ticks</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">bins</span><span class="p">);</span>

		<span class="n">fald_acq_print_data</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cfg_brd</span><span class="p">,</span> <span class="n">cfg_acq</span><span class="p">,</span> <span class="n">show_ndata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
		<span class="n">fald_acq_write_single</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
		<span class="n">fald_acq_write_multiple</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">iteration</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adc_get_conf</span><span class="p">(</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">ADC_CONF_BRD_N_CHAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nchan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">statistics</span><span class="p">)</span>
		<span class="n">adc_acq_statistics</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nchan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg_plot</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">w</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">nchan</span><span class="p">;</span> <span class="o">++</span><span class="n">w</span><span class="p">)</span>
			<span class="n">fald_acq_plot_data</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * It parses the command line arguments for the basic parameters</span>
<span class="cm"> * @param[in] argc number of arguments</span>
<span class="cm"> * @param[in] argv arguments</span>
<span class="cm"> * @return It returns 0 on success, otherwise -1 and errno is appropriately set</span>
<span class="cm"> *</span>
<span class="cm"> * It looks for:</span>
<span class="cm"> * - device ID</span>
<span class="cm"> * - help</span>
<span class="cm"> * - version</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fald_acq_parse_args_basic</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">opt_index</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">getopt_long</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">GETOPT_STRING</span><span class="p">,</span>
				<span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt_index</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;D&#39;</span><span class="o">:</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">strdevid</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">strdevid</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="sc">&#39;@&#39;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strdevid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: invalid device </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> (&lt;type&gt;@&lt;device-id&gt;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">optarg</span><span class="p">);</span>
				<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">strdevid</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* +1 to skip &#39;@&#39; */</span>
			<span class="n">sscanf</span><span class="p">(</span><span class="n">strdevid</span><span class="p">,</span> <span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devid</span><span class="p">);</span>

			<span class="cm">/* -1 count &#39;@&#39; it will be replaced by 0</span>
<span class="cm">			 * +1 for \0</span>
<span class="cm">			 */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">strdevid</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">optarg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">devname</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devname</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Cannot allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="n">optarg</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="sc">&#39;V&#39;</span><span class="o">:</span>
			<span class="n">print_version</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;h&#39;</span><span class="o">:</span>
			<span class="n">fald_help</span><span class="p">();</span>
			<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">default</span><span class="o">:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Within this function we do a single acquisition</span>
<span class="cm"> * @param[in] adc ADC device token</span>
<span class="cm"> * @param[in] buf buffer to use</span>
<span class="cm"> * @param[in] cfg_acq acquisition configuration</span>
<span class="cm"> * @param[in] iteration acquisition number</span>
<span class="cm"> * @return 0 on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adc_acq_acquisition</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_dev</span> <span class="o">*</span><span class="n">adc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="nc">adc_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="nc">adc_conf</span> <span class="o">*</span><span class="n">cfg_brd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="nc">adc_conf</span> <span class="o">*</span><span class="n">cfg_acq</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iteration</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="nc">timeval</span> <span class="n">tv</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="kt">uint32_t</span> <span class="n">nshots</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Acquisition %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iteration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Stop any pending acquisition */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_acq_stop</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Cannot stop pending acquisition: (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">errno</span><span class="p">,</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_acq_start</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">ADC_F_FLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Cannot start acquisition: (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">errno</span><span class="p">,</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adc_get_conf</span><span class="p">(</span><span class="n">cfg_acq</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_PRE_SAMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pre</span><span class="p">);</span>
	<span class="n">adc_get_conf</span><span class="p">(</span><span class="n">cfg_acq</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_POST_SAMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">post</span><span class="p">);</span>
	<span class="n">adc_get_conf</span><span class="p">(</span><span class="n">cfg_acq</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_N_SHOTS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nshots</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">nshots</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;shot: %i/%u, nsamples: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nshots</span><span class="p">,</span> <span class="n">pre</span> <span class="o">+</span> <span class="n">post</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">arg_trgsw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sleep</span><span class="p">(</span><span class="n">arg_trgsw_delay</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">adc_trigger_fire</span><span class="p">(</span><span class="n">adc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_fill_buffer</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				      <span class="n">fixup</span> <span class="o">?</span> <span class="nl">ADC_F_FIXUP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;Failed to retrieve for data: (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">errno</span><span class="p">,</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fald_acq_process_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cfg_brd</span><span class="p">,</span> <span class="n">cfg_acq</span><span class="p">,</span> <span class="n">iteration</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err</span><span class="p">:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Within this function we repeat the same acquisition a number of times</span>
<span class="cm"> * @param[in] adc ADC device token</span>
<span class="cm"> * @param[in] buf buffer to use</span>
<span class="cm"> * @param[in] cfg_acq acquisition configuration</span>
<span class="cm"> * @param[in] n number of acquisition to do</span>
<span class="cm"> * @return 0 on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adc_acq_acquisition_n</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_dev</span> <span class="o">*</span><span class="n">adc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="nc">adc_conf</span> <span class="o">*</span><span class="n">cfg_brd</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="nc">adc_conf</span> <span class="o">*</span><span class="n">cfg_acq</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="nc">adc_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">adc_get_conf</span><span class="p">(</span><span class="n">cfg_acq</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_PRE_SAMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pre</span><span class="p">);</span>
	<span class="n">adc_get_conf</span><span class="p">(</span><span class="n">cfg_acq</span><span class="p">,</span> <span class="n">ADC_CONF_ACQ_POST_SAMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">post</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">adc_request_buffer</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">pre</span> <span class="o">+</span> <span class="n">post</span><span class="p">,</span> <span class="nb">NULL</span> <span class="cm">/* alloc */</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Cannot allocate buffer (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="n">arg_no_read</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adc_acq_acquisition</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">cfg_brd</span><span class="p">,</span> <span class="n">cfg_acq</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adc_release_buffer</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * It configures an acquisition using user&#39;s parameters</span>
<span class="cm"> * @param[in] adc ADC device token</span>
<span class="cm"> * @param[in] argc number of parameters</span>
<span class="cm"> * @param[in] argv user&#39;s parameters</span>
<span class="cm"> * @param[out] cfg_acq acquisition configuration</span>
<span class="cm"> * @return 0 on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adc_acq_configure</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_dev</span> <span class="o">*</span><span class="n">adc</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[],</span>
			     <span class="k">struct</span> <span class="nc">adc_conf</span> <span class="o">*</span><span class="n">cfg_brd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="nc">adc_conf</span> <span class="o">*</span><span class="n">cfg_acq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* get the new given trigger and acq config</span>
<span class="cm">	   Only the ones provided will override the current ones */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">fald_acq_parse_args_and_configure</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Within this program we already know the configuration (we</span>
<span class="cm">	 * applied it before), but here we will retrieve it from the</span>
<span class="cm">	 * library anyway because the library might have changed something</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_conf</span><span class="p">));</span>
	<span class="n">cfg_brd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ADC_CONF_TYPE_BRD</span><span class="p">;</span>
	<span class="n">adc_set_conf_mask_all</span><span class="p">(</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="n">adc</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_retrieve_config</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">cfg_brd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Cannot retrive board configuration: (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">errno</span><span class="p">,</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cfg_acq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adc_conf</span><span class="p">));</span>
	<span class="n">cfg_acq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ADC_CONF_TYPE_ACQ</span><span class="p">;</span>
	<span class="n">adc_set_conf_mask_all</span><span class="p">(</span><span class="n">cfg_acq</span><span class="p">,</span> <span class="n">adc</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_retrieve_config</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">cfg_acq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Cannot retrive acquisition configuration: (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">errno</span><span class="p">,</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * It cleans up our internal mess on exit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adc_acq_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free</span><span class="p">(</span><span class="n">devname</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="nc">adc_dev</span> <span class="o">*</span><span class="n">adc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="nc">adc_conf</span> <span class="n">cfg_acq</span><span class="p">,</span> <span class="n">cfg_brd</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">err</span><span class="p">;</span>

	<span class="n">atexit</span><span class="p">(</span><span class="n">adc_acq_cleanup</span><span class="p">);</span>

	<span class="cm">/* set local _argv[0] with  pg name */</span>
	<span class="n">_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">fald_acq_parse_args_basic</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">exit</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;%s: device is a mandatory argument (%s@0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">devname</span><span class="p">,</span> <span class="n">devid</span><span class="p">);</span>
		<span class="n">fald_help</span><span class="p">();</span>
		<span class="k">goto</span> <span class="n">err_devid_invalid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>

	<span class="cm">/* Open the ADC */</span>
	<span class="n">adc</span> <span class="o">=</span> <span class="n">adc_open</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ADC_F_FLUSH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: cannot open device: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">adc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_open</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_acq_configure</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_acq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_cfg</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">adc_acq_acquisition_n</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_brd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_acq</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_acq</span><span class="p">;</span>
	<span class="n">adc_close</span><span class="p">(</span><span class="n">adc</span><span class="p">);</span>
	<span class="n">adc_exit</span><span class="p">();</span>

	<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>

<span class="nl">err_acq</span><span class="p">:</span>
<span class="nl">err_cfg</span><span class="p">:</span>
	<span class="n">adc_close</span><span class="p">(</span><span class="n">adc</span><span class="p">);</span>
<span class="nl">err_open</span><span class="p">:</span>
<span class="nl">err_devid_invalid</span><span class="p">:</span>
	<span class="n">adc_exit</span><span class="p">();</span>
	<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="tools-example.html" class="btn btn-neutral float-right" title="The Example Tools" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="library-api.html" class="btn btn-neutral float-left" title="The Library API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright CERN 2018, Federico Vaga &lt;federico.vaga@cern.ch&gt;.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>